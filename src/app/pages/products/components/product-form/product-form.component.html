@if (isVisible()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" (click)="onCancel()">
    <div
      class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      (click)="$event.stopPropagation()"
    >
      <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-xl font-semibold text-gray-900">
            {{ this.product()?.id ? translate()?.editProduct : translate()?.createProduct }}
          </h2>
        </div>

        <!-- Form Content -->
        <div class="px-6 py-4 space-y-6">
          <!-- Title -->
          <div>
            @let titleControl = productForm.get('title');

            <label class="form-label">{{ translate()?.fields?.title?.label }} *</label>
            <input
              type="text"
              formControlName="title"
              [placeholder]="translate()?.fields?.title?.placeholder"
              class="form-input"
              [class.border-red-300]="titleControl?.invalid && titleControl?.touched"
            />

            @if (titleControl?.invalid && titleControl?.touched) {
              <div class="form-error">
                @if (titleControl?.errors?.['required']) {
                  <span>{{ translate()?.validation?.titleRequired }}</span>
                }
                @if (titleControl?.errors?.['minlength']) {
                  <span>{{ translate()?.validation?.titleMinLength }}</span>
                }
              </div>
            }
          </div>

          <!-- Description -->
          <div>
            @let descriptionControl = productForm.get('description');

            <label class="form-label">{{ translate()?.fields?.description?.label }} *</label>
            <textarea
              formControlName="description"
              [placeholder]="translate()?.fields?.description?.placeholder"
              rows="3"
              class="form-textarea"
              [class.border-red-300]="descriptionControl?.invalid && descriptionControl?.touched"
            ></textarea>

            @if (descriptionControl?.invalid && descriptionControl?.touched) {
              <div class="form-error">
                @if (descriptionControl?.errors?.['required']) {
                  <span>{{ translate()?.validation?.descriptionRequired }}</span>
                }

                @if (descriptionControl?.errors?.['minlength']) {
                  <span>{{ translate()?.validation?.descriptionMinLength }}</span>
                }
              </div>
            }
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Price -->
            <div>
              @let priceControl = productForm.get('price');

              <label class="form-label">{{ translate()?.fields?.price?.label }} *</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>

                <input
                  type="number"
                  formControlName="price"
                  [placeholder]="translate()?.fields?.price?.placeholder"
                  step="0.01"
                  min="0"
                  class="form-input pl-8"
                  [class.border-red-300]="priceControl?.invalid && priceControl?.touched"
                />
              </div>

              @if (priceControl?.invalid && priceControl?.touched) {
                <div class="form-error">
                  @if (priceControl?.errors?.['required']) {
                    <span>{{ translate()?.validation?.priceRequired }}</span>
                  }

                  @if (priceControl?.errors?.['min']) {
                    <span>{{ translate()?.validation?.priceMin }}</span>
                  }
                </div>
              }
            </div>

            <!-- Stock -->
            <div>
              @let stockControl = productForm.get('stock');

              <label class="form-label">{{ translate()?.fields?.stock?.label }} *</label>
              <input
                type="number"
                formControlName="stock"
                [placeholder]="translate()?.fields?.stock?.placeholder"
                min="0"
                class="form-input"
                [class.border-red-300]="stockControl?.invalid && stockControl?.touched"
              />
              @if (stockControl?.invalid && stockControl?.touched) {
                <div class="form-error">
                  @if (stockControl?.errors?.['required']) {
                    <span>{{ translate()?.validation?.stockRequired }}</span>
                  }

                  @if (stockControl?.errors?.['min']) {
                    <span>{{ translate()?.validation?.stockMin }}</span>
                  }
                </div>
              }
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Category -->
            <div>
              @let categoryControl = productForm.get('category');

              <label class="form-label">{{ translate()?.fields?.category?.label }} *</label>
              @if (categories().length > 0) {
                <select
                  formControlName="category"
                  class="form-select"
                  [class.border-red-300]="categoryControl?.invalid && categoryControl?.touched"
                >
                  <option hidden value="">
                    {{ translate()?.fields?.category?.placeholder }}
                  </option>

                  @for (category of categories(); track $index) {
                    <option [value]="category">
                      {{ category }}
                    </option>
                  }
                </select>
              } @else {
                <input
                  type="text"
                  formControlName="category"
                  class="form-input"
                  [class.border-red-300]="productForm.get('category')?.invalid && productForm.get('category')?.touched"
                />
              }
              @if (categoryControl?.errors?.['required'] && categoryControl?.touched) {
                <div class="form-error">
                  <span>{{ translate()?.validation?.categoryRequired }}</span>
                </div>
              }
            </div>

            <!-- Brand -->
            <div>
              <label class="form-label">
                {{ translate()?.fields?.brand?.label }}
              </label>
              <input
                type="text"
                formControlName="brand"
                [placeholder]="translate()?.fields?.brand?.placeholder"
                class="form-input"
              />
            </div>
          </div>

          <!-- Images Upload -->
          <app-image-upload [images]="productImages()" (imagesChange)="productImages.set($event)" />
        </div>

        <!-- Footer -->
        <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
          <button type="button" class="btn-secondary" (click)="onCancel()">
            {{ translate()?.generic?.cancel }}
          </button>

          <button type="submit" class="btn-primary" [disabled]="productForm.invalid || isSubmitting()">
            @if (isSubmitting()) {
              <div class="flex items-center space-x-2">
                <div class="spinner w-4 h-4"></div>
                <span>{{ translate()?.generic?.loading }}</span>
              </div>
            } @else {
              <span>{{ translate()?.generic?.save }}</span>
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}
